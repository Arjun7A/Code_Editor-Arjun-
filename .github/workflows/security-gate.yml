name: security-gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  security-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Install Semgrep CLI
        run: pip install semgrep

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Run Semgrep Security Gate
        run: |
          semgrep \
            --config=r/python.lang.security \
            --config=r/javascript.lang.security \
            --config=r/generic.secrets \
            --error \
            .

      - name: Run Snyk Security Gate
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN is not set. Skipping Snyk dependency gate."
            exit 0
          fi

          snyk auth "$SNYK_TOKEN"
          set +e
          snyk test --all-projects --severity-threshold=high
          SNYK_EXIT=$?
          set -e

          if [ "$SNYK_EXIT" -eq 1 ]; then
            echo "Snyk found high/critical dependency vulnerabilities."
            exit 1
          fi

          if [ "$SNYK_EXIT" -gt 1 ]; then
            echo "Snyk execution failed with exit code $SNYK_EXIT"
            exit "$SNYK_EXIT"
          fi

      - name: Build backend Docker image
        run: docker build -f backend/Dockerfile backend

      - name: Backend API smoke test
        run: |
          cd backend
          uvicorn app.main:app --host 127.0.0.1 --port 8000 > /tmp/uvicorn.log 2>&1 &
          API_PID=$!

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8000/api/health > /tmp/health.json; then
              break
            fi
            sleep 1
          done

          curl -fsS \
            -X POST "http://127.0.0.1:8000/api/scan" \
            -H "Content-Type: application/json" \
            -d '{"code":"print(\"security-gate\")","filename":"demo.py"}' \
            > /tmp/scan.json

          kill "$API_PID"

      - name: Comment PR with gate result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = `${{ job.status }}`;
            const body = [
              `Security Gate workflow finished with **${status}**.`,
              `- Semgrep gate: executed`,
              `- Snyk gate: executed when \`SNYK_TOKEN\` secret is available`,
              `- Backend Docker build + API smoke test: executed`,
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
